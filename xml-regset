#!/usr/bin/env ruby

require 'pp'
require './netfpga'
require './xml_parser'

unless ARGV.size == 2
  puts "usage: #{$0} XML-config-file register-headers"
  exit 1
end

netfpga = NetFPGA.new ARGV.last

config = XMLParser.parse ARGV.first

pp config

config.each do |eth, params|
  i = eth[/\d$/].to_i

  netfpga.set_local_mac i, params[:local]
  netfpga.set_other_mac i, params[:other]

  netfpga.set_number_of_phases i, params[:phases].size

  params[:phases].each.with_index do |(type, length), ph|
    netfpga.set_phase_type   i, ph, type
    netfpga.set_phase_length i, ph, length
  end
end

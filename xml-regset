#!/usr/bin/env ruby

require 'pp'
require './netfpga'
require './xml_parser'

netfpga = NetFPGA.new ARGV.last

config = XMLParser.parse ARGV.first

pp config

config.each do |eth, params|
  i = eth[/\d$/].to_i

  netfpga.set_local_mac i, params[:local]
  netfpga.set_other_mac i, params[:other]

  netfpga.set "SCHEDULER_#{i}_NUM_PHASES_REG", params[:phases].size

  type_numbers = { 'silent' => 0, 'QoS' => 1, 'CAN' => 2, 'DSS' => 3, 'MGT' => 4 }
  params[:phases].each.with_index do |(type, length), ph|
    netfpga.set "SCHEDULER_#{i}_PH_#{ph+1}_TYPE_REG",   type_numbers[type]
    netfpga.set "SCHEDULER_#{i}_PH_#{ph+1}_LENGTH_REG", length
  end
end
